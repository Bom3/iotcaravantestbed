# NerveNetトライアル利用マニュアル
基地局同士が自動的に相互接続する機能を持ち、災害時に一部のルートで障害が発生しても直ちに別のルートに切り替え、通信を確保する無線マルチホップ技術を用いた分散ネットワークです。各基地局が通信機能に加えてデータの蓄積・同期機能を有しており、アプリケーションと連携することで、データ配信や共有を行うことが可能です。
詳細は NICTの[NerveNetのサイト](https://www.nict.go.jp/out-promotion/other/case-studies/itenweb/nervenet.html) をご覧ください。

本トライアルは、NerveNetの通信機能を実体験することで、耐障害性・耐災害性を有するネットワーク上でのアプリケーション検証などを行うことができます。

## 貸出品一式と必要なもの

- 貸出品
  - NerveNetインストール済み Raspberry Pi (以下、RasPi） : 3台
  - NerveNetインストール済み ネットワーク装置 （以下、BS）: 1台
  
- 必要なもの
  - NerveNetに接続するIoTデバイス
    - IP通信ができるデバイスが必要です
  - インターネット接続環境
    - DHCPでIPアドレスが取得できる環境が必要です
  - 可視化用パソコン（NerveNetの動作を可視化する場合）
    - 可視化用アプリケーションのインストールが別途必要になります
    - Ubuntu 16.04.5 LTS (32ビットOS）が推奨されています
    
## トライアル構成

事前に設定されているトライアル構成は下図の通りです。本マニュアルでは、ネットワーク装置にはBS13のIDが付与されており, RasPiにはそれぞれID150, ID151, ID152のIDが付与されているものとして説明します。

![nerve](https://user-images.githubusercontent.com/4217754/47858865-4e677680-de30-11e8-87b0-52356a3e9357.png)

ネットワーク装置は、以下の4つのポートを備えています。
  - インターネット接続用ポート
  - 基地局間接続用ポート（×２）
  - アクセスポート


インターネット接続用ポートには外部ネットワーク（インターネット回線）からの配線を接続し、基地局間接続用ポートにRasPi(ID150, ID152)の配線（2本）を接続します。RasPiには内蔵無線インタフェース(11g)と2つの外付け無線インタフェース（11a）、有線インタフェースを具備しています。NerveNetの特性であるメッシュネットワークを体験するために、有線と無線のリンクを用意します。上記の通り接続して、機器の電源をオンにすると自動でメッシュネットワークを構築します。

3台のRasPiには、事前設定で独立した無線LAN（異なるネットワークセグメント）が提供されています。デバイスIDや設定されたネットワークセグメントは貸出機器ごとに異なります。本説明における、初期状態では 172.16.${デバイスID}.0/24 が設定されています（ネットワークA（ID:150）,ネットワークB（ID:151）,ネットワークC（ID:152））。

## 使い方（基本編）

### その1. IoTデバイスをつないでみる

1. IoTデバイスを繋ぎたいRasPiが提供するユーザアクセス用のSSIDに接続します。ここではネットワークB（ID151）に接続してみます
1. IoTデバイスにDHCPでIPアドレスが自動付与されます
1. IoTデバイスから異なるRasPiが提供するネットワーク配下のノードやインターネットアクセスをしてみます

![01_ssid](https://user-images.githubusercontent.com/4217754/47611852-4d8db800-dab1-11e8-9a7a-d66ab16fbec4.png)
![02_ipconfig](https://user-images.githubusercontent.com/4217754/47611853-53839900-dab1-11e8-870b-37a435a09a3b.png)
![03_internet](https://user-images.githubusercontent.com/4217754/47611860-7910a280-dab1-11e8-8898-b6a071d2fd84.png)

### その2. 耐障害性の体験してみる

NerveNetの特長のひとつである、メッシュネットワークによる耐障害性を体験し、IoTデバイスやアプリケーションの挙動を検証することができます。
ここでは以下に示す通り、複数のリンクを切断・接続を繰り返しながら、通信に与える影響を観測してみます。

1. ID152とBS13の間の有線LANを切断してみます
1. ID150とBS13の間の有線LANを切断してみます。完全に上流との間で切断が発生します
1. ID152とBS13の間の有線LANを接続してみます。通信が復旧します
1. ID150とBS13の間の有線LANを接続してみます。全リンクが復旧します
1. ID152のRasPiの電源を落としてみます

![05_dest](https://user-images.githubusercontent.com/4217754/47611955-7ca52900-dab3-11e8-9bc8-7846d007b397.png)

上記のようにリンクを切断・接続しながら、通信路が自動で切り替わりインターネット接続が継続されることを確認することができます。


### その3. メッシュネットワークを可視化する（オプション）

可視化用パソコンを用意すると、NerveNetのメッシュネットワークの状態をリアルタイムでモニタすることが可能になります。
標準では以下のプログラムが用意されています。

- monitor-link: NerveNet基地局間のリンク状態を表示
- monitor-tree: NerveNet上に構築された複数のツリー状のVLANパスを表示
- monitor-boat: NerveNetに接続された端末アプリケーションの一覧を表示
- monitor-path: どの基地局へは、どのVLANツリーを用いて通信するかの対応を表示
- monitor-port: 基地局の何番ポートが、どの基地局の何番ポートに接続されているかの対応表一覧を表示

> インストール方法はNerveNetのマニュアルをご確認ください。

具体的な手順は以下の通りです。

1. 可視化パソコンを「その1」で示したNerveNetのネットワークに接続します
1. ターミナルを起動し、表示したい内容に応じてコマンドを入力します。例えば、リンク状態を確認するには以下のコマンドを利用します
1. 「その2」で示した通り、リンクを切断すると、下図のようにリンクの色が変化します

        /writable/sbin/monitor-link --config=/writable/etc/monitor-link.conf

![14_connect-id150_bs13](https://user-images.githubusercontent.com/4217754/47611883-02c07000-dab2-11e8-9ee1-5696b4dc8840.png)
![11_distconnect-id152_bs13](https://user-images.githubusercontent.com/4217754/47611884-03f19d00-dab2-11e8-8f22-71a82583d731.png)
![12_distconnect-id150_bs13](https://user-images.githubusercontent.com/4217754/47611885-05bb6080-dab2-11e8-8288-a0e9221b5bb1.png)
![15_poweroff-id152](https://user-images.githubusercontent.com/4217754/47611886-06ec8d80-dab2-11e8-8844-b630f04ba449.png)

## 使い方（アドバンスド編）

### NerveNetアプリを体験してみる

NerveNetは,基地局内データベースによるネットワーク内のデータ蓄積・同期機能を具備しています。本トライアルキットで提供するRasPiでも利用できる状態になっているため、
本機能を利用したNerveNetアプリを体験してみます。

TBD

## 次のステップに向けて

本トライアルで、NerveNetの特長や使い方を体験してもらった後に、次のステップとして例えば以下のような活用が可能です。ぜひ検討してみてください。

### IoTゲートウェイと連携してNICT総合テストベッドと接続する
TBD

### アクセスネットワークにLPWA(LoRa）を利用する
TBD

## その他・注意事項
